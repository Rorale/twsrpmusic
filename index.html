<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TWS Music Host Site - Upload & Share</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script> 
    <style>
        /* Paleta de colores Oscura */
        :root {
            --color-bg-light: #1f2937; /* Fondo oscuro principal */
            --color-bg-card: #374151; /* Fondo de tarjetas/secundario */
            --color-text: #f3f4f6; /* Texto claro */
            --color-input-bg: #4b5563; /* Fondo de inputs */
            --color-primary: #3b82f6; /* Azul brillante para acciones (Upload) */
            --color-primary-hover: #2563eb;
            --color-secondary: #f59e0b; /* Naranja/Amarillo para el botón de acceso */
            --color-danger: #ef4444; /* Rojo para errores/eliminar */
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--color-bg-light); 
            color: var(--color-text); 
        }
        .container { max-width: 90%; margin: 0 auto; padding: 20px; }
        .card { 
            background-color: var(--color-bg-card); 
            border: 1px solid #4b5563; /* Borde sutil */
            border-radius: 12px; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .input-style { 
            background-color: var(--color-input-bg); 
            border: 1px solid #6b7280; 
            color: var(--color-text);
            border-radius: 8px;
        }
        /* Botones de acción */
        .btn-primary { background-color: var(--color-primary); color: white; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: var(--color-primary-hover); }
        .btn-secondary { background-color: var(--color-secondary); color: white; transition: background-color 0.2s; }
        .btn-secondary:hover { background-color: #d97706; }
        .btn-danger { background-color: var(--color-danger); color: white; cursor: not-allowed; transition: background-color 0.2s; }
        .btn-danger:hover { background-color: #dc2626; }
        .nav-link { cursor: pointer; padding: 8px 12px; border-radius: 6px; }
        .nav-link.active { background-color: var(--color-primary); color: white; }

        /* Player styles */
        audio::-webkit-media-controls-panel { background-color: #4b5563; border-radius: 8px; }
        audio { height: 40px; } /* Ajuste de altura */

        /* Estilo para las tarjetas de canciones/carpetas */
        .song-item, .folder-item, .folder-song-item {
            border: 1px solid #4b5563;
            border-radius: 8px;
            background-color: #4b5563; /* Más oscuro que el fondo principal para destacar */
            transition: box-shadow 0.2s;
        }
        .song-item:hover, .folder-item:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Ocultar el estado de inicio de sesión para el usuario final */
        #login-status-message { display: none; }
    </style>
</head>
<body class="min-h-screen p-4">

    <header class="flex justify-between items-center py-4 border-b border-gray-600 mb-6">
        <h1 class="text-3xl font-extrabold text-gray-100">
            <span class="text-blue-500">T</span><span class="text-yellow-500">W</span><span class="text-red-500">S</span> Music Host Site
        </h1>
        <nav class="flex items-center space-x-2">
            <div class="flex space-x-2">
                <span id="nav-home" class="nav-link active font-medium" data-view="home">Home & Upload</span>
                <span id="nav-folders" class="nav-link font-medium" data-view="folders">Folders</span>
            </div>
            <button id="settings-btn" class="p-2 rounded-full hover:bg-gray-700 transition" onclick="showModal('settingsModal')">
                 <i data-lucide="settings" class="w-5 h-5 text-gray-400"></i>
            </button>
        </nav>
    </header>

    <div id="main-content-container" class="hidden">
        
        <div id="home-view" class="lg:flex lg:space-x-8">
            <div id="upload-card" class="w-full lg:w-1/2 p-6 card mb-8 lg:mb-0">
                <h2 class="text-2xl font-bold mb-6 text-center text-gray-100">Upload your MP3s here</h2>

                <div id="upload-status" class="hidden p-3 rounded-lg text-sm mb-4 font-semibold" role="alert"></div>

                <form id="uploadForm" class="space-y-6">
                    <p class="text-red-400 text-sm font-semibold">
                        Note: Max. file size upload is 40MB. The use of this site is intended for RP purposes only.
                    </p>

                    <div>
                        <label for="mp3File" class="block text-sm font-medium mb-1 text-gray-300">Choose MP3 File</label>
                        <input type="file" id="mp3File" accept="audio/mp3" required class="input-style p-3 w-full rounded-lg cursor-pointer file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-800 file:text-blue-200 hover:file:bg-blue-700">
                    </div>

                    <div>
                        <label for="customName" class="block text-sm font-medium mb-1 text-gray-300">Custom Name (Used for URL)</label>
                        <input type="text" id="customName" placeholder="Ex: Airship (will be airship.mp3 in URL)" class="input-style p-3 w-full rounded-lg">
                    </div>
                    
                    <button type="submit" id="uploadButton" class="w-full py-3 rounded-lg font-bold text-lg btn-danger" disabled>
                        DB Configuration MISSING
                    </button>

                    <div id="login-status-message" class="text-center text-sm text-gray-400 py-2 rounded-md">
                        Please log in to access the system.
                    </div>
                </form>
            </div>

            <div id="links-card" class="w-full lg:w-1/2 p-6 card">
                <h2 class="text-2xl font-bold mb-6 text-center text-gray-100">Uploaded Music Links</h2>
                
                <div id="loading-spinner" class="hidden text-center py-10">
                    <div class="animate-spin inline-block w-8 h-8 border-4 border-t-4 border-blue-400 border-opacity-25 rounded-full"></div>
                    <p class="text-blue-400 mt-2">Cargando canciones...</p>
                </div>

                <p class="text-right text-gray-400 mb-4">Total: <span id="song-count" class="font-bold">0</span> songs</p>

                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0 sm:space-x-4">
                    <input type="text" id="search-input" placeholder="Search song by name..." class="input-style p-3 rounded-lg w-full sm:w-2/3">
                    <div class="flex space-x-2 text-sm text-gray-300 font-medium">
                        <label><input type="radio" name="sort" value="alpha" class="text-blue-400"> Alphabetical</label>
                        <label><input type="radio" name="sort" value="newest" checked class="text-blue-400"> Newest</label>
                        <label><input type="radio" name="sort" value="oldest" class="text-blue-400"> Oldest</label>
                    </div>
                </div>

                <div id="music-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                    <div id="no-songs-message" class="text-center text-gray-500 mt-10 hidden">
                        No hay canciones subidas todavía. ¡Sube la primera!
                    </div>
                </div>
            </div>
        </div>

        <div id="folders-view" class="hidden p-6 card">
            <div id="folders-main-content">
                <div class="flex justify-between items-center mb-6 border-b border-gray-600 pb-4">
                    <h2 class="text-2xl font-bold text-gray-100">User Folders (Playlists)</h2>
                    <button class="py-2 px-4 rounded-lg text-white font-semibold bg-green-600 hover:bg-green-700 transition" onclick="showModal('createFolderModal')">
                        <i data-lucide="folder-plus" class="w-5 h-5 inline mr-1"></i> Create New Folder
                    </button>
                </div>

                <div id="folder-loading-spinner" class="hidden text-center py-10">
                    <div class="animate-spin inline-block w-8 h-8 border-4 border-t-4 border-blue-400 border-opacity-25 rounded-full"></div>
                    <p class="text-blue-400 mt-2">Cargando carpetas...</p>
                </div>
                
                <div id="folders-list" class="space-y-4 min-h-[400px]">
                    <div id="no-folders-message" class="text-center text-gray-500 mt-10">
                        No hay carpetas creadas. Sé el primero en crear una.
                    </div>
                </div>
            </div>

            <div id="folder-detail-view" class="hidden mt-8 p-6 card w-full">
                <button id="back-to-folders-btn" class="text-blue-400 hover:text-blue-300 mb-4 font-semibold">&larr; Back to Folders</button>
                <div class="flex justify-between items-center border-b border-gray-600 pb-3 mb-4">
                    <h3 id="folder-detail-name" class="text-3xl font-bold text-yellow-400"></h3>
                    <p class="text-sm text-gray-400">Owner: <span id="folder-detail-owner" class="font-medium"></span></p>
                </div>
                
                <p class="text-gray-400 mb-4">Drag and drop songs below to reorder your playlist.</p>
                
                <div id="folder-songs-list" class="space-y-3">
                    </div>

                <div class="mt-6 flex justify-end">
                    <button id="save-order-btn" class="py-2 px-4 rounded-lg text-white font-semibold bg-green-600 hover:bg-green-700 transition" disabled>
                        Save Order
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-95 flex items-center justify-center z-[100]">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-sm border-2 border-yellow-500">
            <h3 class="text-2xl font-bold mb-4 text-center text-red-400">ACCESS DENIED</h3>
            <p class="text-gray-300 mb-6 text-center">Please enter the password in order to gain access.</p>

            <div id="password-status" class="hidden p-2 rounded-md text-sm mb-4 font-medium text-white bg-red-600"></div>

            <label for="password-input-access" class="block text-sm font-medium mb-1 text-gray-300">Password required</label>
            <input type="password" id="password-input-access" class="input-style p-3 w-full mb-4 text-center" placeholder="*************">
            
            <button id="enter-access-btn" class="w-full py-3 rounded-lg font-bold text-lg btn-secondary">
                Enter
            </button>
        </div>
    </div>
    <footer class="mt-8 pt-4 text-center text-sm text-gray-400 border-t border-gray-600">
        &copy; 2025 made by Rorale. All rights reserved.
    </footer>

    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="bg-gray-700 p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">Settings</h3>
            <p class="text-sm text-yellow-300 mb-4">
                ⚠️ **Permisos de DB:** Si no puedes guardar, verifica que tus Reglas de Seguridad de Firestore permitan *lectura y escritura* en las colecciones públicas.
            </p>
            <div id="nickname-status" class="hidden p-2 rounded-md text-sm mb-4 font-medium"></div>

            <label for="nickname-input" class="block text-sm font-medium mb-1 text-gray-300">Your Nickname</label>
            <input type="text" id="nickname-input" class="input-style p-2 w-full mb-4" placeholder="Enter your desired nickname">
            
            <div class="flex justify-end space-x-2">
                <button class="py-2 px-4 rounded-lg text-white font-semibold bg-red-600 hover:bg-red-700 transition" onclick="hideModal('settingsModal')">Close</button>
                <button id="save-nickname-btn" class="py-2 px-4 rounded-lg text-white font-semibold bg-blue-600 hover:bg-blue-700 transition">Save Nickname</button>
            </div>
        </div>
    </div>

    <div id="createFolderModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="bg-gray-700 p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">Create New Folder</h3>
            <div id="folder-creation-status" class="hidden p-2 rounded-md text-sm mb-4 font-medium"></div>

            <label for="folder-name-input" class="block text-sm font-medium mb-1 text-gray-300">Folder Name</label>
            <input type="text" id="folder-name-input" class="input-style p-2 w-full mb-4" placeholder="Ex: Best of RPGs OST">
            
            <div class="flex justify-end space-x-2">
                <button class="py-2 px-4 rounded-lg text-white font-semibold bg-red-600 hover:bg-red-700 transition" onclick="hideModal('createFolderModal')">Cancel</button>
                <button id="create-folder-btn" class="py-2 px-4 rounded-lg text-white font-semibold bg-green-600 hover:bg-green-700 transition">Create Folder</button>
            </div>
        </div>
    </div>

    <div id="addSongModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="bg-gray-700 p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">Add "<span id="song-to-add-name" class="text-yellow-400"></span>" to Folder</h3>
            <div id="add-song-status" class="hidden p-2 rounded-md text-sm mb-4 font-medium"></div>

            <label for="folder-select" class="block text-sm font-medium mb-1 text-gray-300">Select Folder</label>
            <select id="folder-select" class="input-style p-2 w-full mb-4">
                <option value="" disabled selected>-- Select a folder --</option>
            </select>
            
            <div class="flex justify-end space-x-2">
                <button class="py-2 px-4 rounded-lg text-white font-semibold bg-red-600 hover:bg-red-700 transition" onclick="hideModal('addSongModal')">Cancel</button>
                <button id="confirm-add-song-btn" class="py-2 px-4 rounded-lg text-white font-semibold bg-blue-600 hover:bg-blue-700 transition" disabled>Add Song</button>
            </div>
        </div>
    </div>

    <script>
        // Hacemos que estas funciones sean globales y accesibles desde el atributo onclick="" del HTML.
        function showModal(id) {
            document.getElementById(id)?.classList.remove('hidden');
        }

        function hideModal(id) {
            document.getElementById(id)?.classList.add('hidden');
        }
    </script>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, deleteDoc, doc, setDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Inicializar iconos de Lucide
        lucide.createIcons();

        // --- CONSTANTES DE SEGURIDAD Y TIEMPO (NUEVO) ---
        const CORRECT_PASSWORD = "jawoHL_66";
        const PASSWORD_STORAGE_KEY = "tws_access_valid_until";
        const THREE_DAYS_MS = 3 * 24 * 60 * 60 * 1000;
        // --- FIN CONSTANTES DE SEGURIDAD Y TIEMPO ---
        
        // --- FUNCIONES DE UTILIDAD PARA CLOUDINARY ---
        // Función para limpiar una cadena y hacerla segura para URL/Public ID, manteniendo la capitalización.
        function createSafePublicId(text) {
            return text
                .trim()
                // Eliminar caracteres problemáticos de Cloudinary/filesystem, pero mantener A-Z y a-z
                .replace(/[\\/:*?"<>|&#]/g, '') 
                // Reemplazar espacios, guiones y puntos con guión bajo (underscore)
                .replace(/[\s\-\.]+/g, '_');    
        }
        // --- FIN FUNCIONES DE UTILIDAD ---

        // Configuración Global y Variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfigRaw = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Variables de Firebase
        let app, db, auth, userId = null;
        let isAuthReady = false;

        // --- CONFIGURACIÓN DE CLOUDINARY (IMPORTANTE) ---
        // TODO: Asegúrate de reemplazar "daj3jaqd9" y "tws_music_uploads" con tus valores reales.
        const CLOUDINARY_CONFIG = {
            cloudName: "daj3jaqd9",
            uploadPreset: "tws_music_uploads",
            folder: "music" 
        };
        // --- FIN CONFIGURACIÓN CLOUDINARY ---

        // --- CONFIGURACIÓN DE FIRESTORE ---
        const SONG_COLLECTION_NAME = 'uploaded_songs_cloudinary'; // Catálogo de canciones
        const PROFILE_COLLECTION_NAME = 'user_profiles'; // Catálogo de perfiles/nicknames
        const FOLDER_COLLECTION_NAME = 'user_folders'; // Catálogo de carpetas

        // Elementos del DOM
        const uploadButton = document.getElementById('uploadButton');
        const uploadStatus = document.getElementById('upload-status');
        const uploadForm = document.getElementById('uploadForm');
        const musicList = document.getElementById('music-list');
        const songCountElement = document.getElementById('song-count');
        const loginStatusMessage = document.getElementById('login-status-message');
        const searchInput = document.getElementById('search-input');
        const sortRadios = document.querySelectorAll('input[name="sort"]');
        const noSongsMessage = document.getElementById('no-songs-message');
        const loadingSpinner = document.getElementById('loading-spinner');
        const foldersList = document.getElementById('folders-list');
        const noFoldersMessage = document.getElementById('no-folders-message');
        const saveOrderBtn = document.getElementById('save-order-btn');
        const folderDetailView = document.getElementById('folder-detail-view');
        const foldersMainContent = document.getElementById('folders-main-content');
        const homeView = document.getElementById('home-view'); 
        const foldersView = document.getElementById('folders-view'); 
        const backToFoldersBtn = document.getElementById('back-to-folders-btn'); 
        
        // Elementos DOM para el nuevo acceso (NUEVO)
        const passwordModal = document.getElementById('password-modal');
        const mainContentContainer = document.getElementById('main-content-container');
        const passwordInput = document.getElementById('password-input-access');
        const enterAccessBtn = document.getElementById('enter-access-btn');
        const passwordStatus = document.getElementById('password-status');
        
        // Estado de la interfaz
        let allSongs = [];
        let userProfiles = {}; // Cache para nicknames
        let allFolders = [];
        let currentView = 'home';
        let currentFolderId = null; 
        let songToAddMetadata = null; 

        // Función para obtener la configuración (DATOS INSERTADOS AQUÍ)
        function getFirebaseConfig() {
            // --- CONFIGURACIÓN MANUAL DE FIREBASE INSERTADA (BLOQUE PROPORCIONADO POR EL USUARIO) ---
            const YOUR_FIREBASE_CONFIG = {
                apiKey: "AIzaSyBipp_qEAamELRQJDGz7wWb6LUDyj7-cRQ",
                authDomain: "music-host-site.firebaseapp.com",
                projectId: "music-host-site",
                storageBucket: "music-host-site.firebasestorage.app",
                messagingSenderId: "761480568190",
                appId: "1:761480568190:web:0b9ff1adbe1843c86f672f",
                measurementId: "G-B15CZRFHK5"
            };
            // --- FIN CONFIGURACIÓN MANUAL DE FIREBASE ---

            if (firebaseConfigRaw) {
                try {
                    const envConfig = JSON.parse(firebaseConfigRaw);
                    if (envConfig && envConfig.apiKey) {
                        return envConfig;
                    }
                } catch (e) {
                    console.error("Error parsing Firebase environment configuration:", e);
                }
            }
            
            return YOUR_FIREBASE_CONFIG;
        }

        // --- FUNCIONES DE UTILIDAD DE UI ---
        function displayStatus(message, type = 'bg-blue-800', element = uploadStatus) {
            element.textContent = message;
            element.className = `p-3 rounded-lg text-sm mb-4 font-semibold ${type} text-white`;
            element.classList.remove('hidden');
            setTimeout(() => {
                element.classList.add('hidden');
            }, 8000);
        }
        
        // Función para mostrar estado en la modal de contraseña (NUEVO)
        function displayPasswordStatus(message, type = 'bg-red-600') {
            passwordStatus.textContent = message;
            passwordStatus.className = `p-2 rounded-md text-sm mb-4 font-medium text-white ${type}`;
            passwordStatus.classList.remove('hidden');
            setTimeout(() => {
                 passwordStatus.classList.add('hidden');
            }, 5000);
        }

        // Lógica para alternar las vistas sin superponerse (comportamiento de pestañas)
        function showView(viewName) {
            homeView.classList.add('hidden');
            foldersView.classList.add('hidden');
            folderDetailView.classList.add('hidden');
            foldersMainContent.classList.remove('hidden'); 

            if (viewName === 'home') {
                homeView.classList.remove('hidden');
                currentFolderId = null;
            } else if (viewName === 'folders') {
                foldersView.classList.remove('hidden');
                currentFolderId = null;
            } else if (viewName.startsWith('folderDetail-')) {
                const folderId = viewName.split('-')[1];
                currentFolderId = folderId;
                foldersView.classList.remove('hidden'); 
                foldersMainContent.classList.add('hidden'); 
                folderDetailView.classList.remove('hidden'); 
                renderFolderDetail(folderId);
            }

            // Manejar clase activa del navbar
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            const navKey = viewName.startsWith('folderDetail') ? 'folders' : viewName;
            document.getElementById(`nav-${navKey}`).classList.add('active');

            currentView = viewName;
        }

        // --- LÓGICA DE NICKNAME ---

        async function saveNickname(nickname) {
            const statusElement = document.getElementById('nickname-status');
            statusElement.classList.add('hidden');

            if (!db || !userId) {
                 displayStatus('Error: DB o Usuario no disponible.', 'bg-red-600', statusElement);
                 return;
            }

            try {
                const profileRef = doc(db, `artifacts/${appId}/public/data/${PROFILE_COLLECTION_NAME}`, userId);
                await setDoc(profileRef, { nickname: nickname.trim(), lastUpdate: new Date() }, { merge: true });
                displayStatus(`Nickname guardado: ${nickname}`, 'bg-green-600', statusElement);
                userProfiles[userId] = nickname.trim();
                filterAndSortSongs();
            } catch (error) {
                // Si falla por permisos, debe ser visible al usuario
                console.error("Error saving nickname:", error);
                displayStatus('Error al guardar el nickname. Revisa los permisos de Firestore.', 'bg-red-600', statusElement);
            }
        }

        function setupProfilesListener() {
            if (!db || !userId) return;
            const collectionPath = `artifacts/${appId}/public/data/${PROFILE_COLLECTION_NAME}`;
            const q = query(collection(db, collectionPath));

            onSnapshot(q, (snapshot) => {
                userProfiles = {};
                snapshot.forEach((doc) => {
                    userProfiles[doc.id] = doc.data().nickname || `User-${doc.id.substring(0, 5)}`;
                });
                
                if (currentView === 'home') {
                    filterAndSortSongs();
                }
            }, (error) => {
                // Si falla por permisos, mostrar error en consola
                console.error("Error fetching profiles (Permissions?):", error);
            });
        }
        
        // --- LÓGICA DE SUBIDA DE ARCHIVOS ---
        async function uploadFileAndSaveMetadata(file, customName) {
            if (!db || !userId) {
                displayStatus("Error: No autenticado o DB no inicializada.", 'bg-red-600');
                return;
            }

            const { cloudName, uploadPreset, folder } = CLOUDINARY_CONFIG;
            const url = `https://api.cloudinary.com/v1_1/${cloudName}/upload`;
            
            const songName = customName || file.name.split('.').slice(0, -1).join('.');
            // CORRECCIÓN: Usamos createSafePublicId para mantener la capitalización.
            const safePublicId = createSafePublicId(songName); 

            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', uploadPreset);
            formData.append('folder', folder);
            
            // CRÍTICO: Usar el nombre seguro y con case para el public_id si se proporcionó un nombre personalizado.
            if (customName) {
                formData.append('public_id', safePublicId);
            }
            
            uploadButton.textContent = "Uploading..."; 
            uploadButton.disabled = true;

            try {
                // 1. Subir a Cloudinary
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Cloudinary Upload Failed: ${errorData.error ? errorData.error.message : response.statusText}.`);
                }

                const data = await response.json();
                
                // 2. Guardar metadatos en Firestore
                const collectionPath = `artifacts/${appId}/public/data/${SONG_COLLECTION_NAME}`;
                
                const songData = {
                    name: songName,            // Nombre que se muestra en la lista
                    fileName: file.name,
                    url: data.secure_url,      // URL real de Cloudinary
                    uploadedBy: userId,
                    timestamp: new Date(),
                    cloudinaryId: data.public_id, // ID público exacto en Cloudinary
                    shortName: safePublicId       // Nombre corto para /music/Space
                };


                await addDoc(collection(db, collectionPath), songData);
                
                displayStatus(`¡"${songName}" subida y registrada con éxito! Enlace URL limpio generado.`, 'bg-green-600');

            } catch (error) {
                console.error("Upload Error:", error);
                displayStatus(`Error durante la subida o registro: ${error.message || error}`, 'bg-red-600');
            } finally {
                uploadButton.textContent = "Upload";
                uploadButton.disabled = false;
            }
        }

        // --- LÓGICA DE FIREBASE PARA CANCIONES (Catálogo principal) ---
        
        function setupSongsListener() {
            if (!db || !userId) return;

            loadingSpinner.classList.remove('hidden');
            musicList.innerHTML = '';
            
            const collectionPath = `artifacts/${appId}/public/data/${SONG_COLLECTION_NAME}`;
            const q = query(collection(db, collectionPath));

            onSnapshot(q, (snapshot) => {
                loadingSpinner.classList.add('hidden');
                allSongs = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    allSongs.push({
                        id: doc.id,
                        ...data,
                        timestamp: data.timestamp ? data.timestamp.toDate() : new Date(0)
                    });
                });
                filterAndSortSongs();
            }, (error) => {
                console.error("Error fetching songs (Permissions?):", error);
                loadingSpinner.classList.add('hidden');
                displayStatus('Error cargando la lista. Revisa las Reglas de Seguridad de Firestore.', 'bg-yellow-600');
            });
        }

        function filterAndSortSongs() {
            let tempSongs = [...allSongs];
            const searchTerm = searchInput.value.toLowerCase();
            const sortOrder = document.querySelector('input[name="sort"]:checked').value;

            // 1. Filtrado
            if (searchTerm) {
                tempSongs = tempSongs.filter(song => 
                    song.name.toLowerCase().includes(searchTerm) || 
                    song.fileName.toLowerCase().includes(searchTerm)
                );
            }
            
            // 2. Ordenación
            if (sortOrder === 'alpha') {
                tempSongs.sort((a, b) => a.name.localeCompare(b.name));
            } else if (sortOrder === 'newest') {
                tempSongs.sort((a, b) => b.timestamp - a.timestamp);
            } else if (sortOrder === 'oldest') {
                tempSongs.sort((a, b) => a.timestamp - b.timestamp);
            }

            renderMusicList(tempSongs);
        }
        
        function renderMusicList(songs) {
            musicList.innerHTML = '';
            songCountElement.textContent = songs.length;
            
            if (songs.length === 0) {
                noSongsMessage.classList.remove('hidden');
            } else {
                noSongsMessage.classList.add('hidden');
                songs.forEach(song => {
                    const songElement = createSongElement(song);
                    musicList.appendChild(songElement);
                });
            }
        }

        function createSongElement(song) {
            const div = document.createElement('div');
            div.className = 'song-item p-3 flex flex-col md:flex-row justify-between items-center';
            div.id = `song-${song.id}`;

            const name = song.name || song.fileName;
            const externalLink = song.url; 
            const uploaderName = userProfiles[song.uploadedBy] || `User-${song.uploadedBy.substring(0, 8)}...`;


            div.innerHTML = `
                <div class="flex-grow w-full md:w-auto mb-3 md:mb-0">
                    <p class="font-semibold text-lg text-gray-100">${name}</p>
                    <p class="text-xs text-gray-400">URL ID: ${song.cloudinaryId || 'N/A'}</p>
                    <p class="text-xs text-gray-400">Uploaded by: ${uploaderName}</p>
                    <p class="text-xs text-gray-400">Date: ${song.timestamp.toLocaleDateString()}</p>
                    <audio controls class="mt-2 w-full">
                        <source src="${externalLink}" type="audio/mp3">
                        Your browser does not support the audio element.
                    </audio>
                </div>
                <div class="flex flex-shrink-0 space-x-2 mt-2 md:mt-0">
                    <button class="add-to-folder-btn py-2 px-4 rounded-lg text-white font-semibold btn-secondary transition" data-id="${song.id}" data-name="${name}">
                        Add to Folder
                    </button>
                    <button class="copy-btn py-2 px-4 rounded-lg text-white font-semibold bg-green-600 hover:bg-green-700 transition" data-url="${externalLink}">
                        Copy Link
                    </button>
                    ${song.uploadedBy === userId ? 
                        `<button class="delete-btn py-2 px-4 rounded-lg text-white font-semibold bg-red-600 hover:bg-red-700 transition" data-id="${song.id}" data-cloudinary-id="${song.cloudinaryId}">
                            Delete
                        </button>` 
                        : ''}
                </div>
            `;

            div.querySelector('.copy-btn').addEventListener('click', (e) => {
                const url = e.currentTarget.getAttribute('data-url');
                copyToClipboard(url);
            });
            
            div.querySelector('.add-to-folder-btn').addEventListener('click', (e) => {
                songToAddMetadata = {
                    id: e.currentTarget.getAttribute('data-id'),
                    name: e.currentTarget.getAttribute('data-name')
                };
                openAddSongModal();
            });

            const deleteBtn = div.querySelector('.delete-btn');
            if (deleteBtn) {
                 deleteBtn.addEventListener('click', (e) => {
                    const songId = e.currentTarget.getAttribute('data-id');
                    const cloudinaryId = e.currentTarget.getAttribute('data-cloudinary-id');
                    
                    // Nota: Aquí se usa confirm() temporalmente para evitar modales complejos en HTML
                    if (confirm("¿Estás seguro de que quieres eliminar esta canción? (Solo elimina el registro de la DB)")) {
                        deleteSong(songId, cloudinaryId);
                    }
                });
            }

            return div;
        }
        
        async function deleteSong(songId, cloudinaryId) {
            if (!db || !userId) {
                displayStatus("Error: No autenticado.", 'bg-red-600');
                return;
            }
            
            try {
                const collectionPath = `artifacts/${appId}/public/data/${SONG_COLLECTION_NAME}`;
                const docRef = doc(db, collectionPath, songId);
                await deleteDoc(docRef);
                displayStatus("Canción eliminada del registro.", 'bg-yellow-600');
            } catch (error) {
                console.error("Error deleting song from Firestore:", error);
                displayStatus(`Error eliminando la canción: ${error.message}`, 'bg-red-600');
            }
        }
        
        // --- LÓGICA DEL MODAL AÑADIR CANCIÓN A CARPETA ---

        function openAddSongModal() {
            const songNameElement = document.getElementById('song-to-add-name');
            const folderSelect = document.getElementById('folder-select');
            const confirmBtn = document.getElementById('confirm-add-song-btn');

            songNameElement.textContent = songToAddMetadata.name;
            folderSelect.innerHTML = '<option value="" disabled selected>-- Select a folder --</option>';
            confirmBtn.disabled = true;

            allFolders.forEach(folder => {
                const option = document.createElement('option');
                option.value = folder.id;
                option.textContent = `${folder.name} (${folder.ownerNickname})`;
                folderSelect.appendChild(option);
            });

            folderSelect.onchange = () => {
                confirmBtn.disabled = !folderSelect.value;
            };

            showModal('addSongModal');
        }
        
        document.getElementById('confirm-add-song-btn').addEventListener('click', async () => {
            if (!songToAddMetadata || !db || !userId) return;

            const folderId = document.getElementById('folder-select').value;
            if (!folderId) return;
            
            const statusElement = document.getElementById('add-song-status');
            statusElement.classList.add('hidden');

            const folder = allFolders.find(f => f.id === folderId);
            if (!folder) {
                displayStatus('Carpeta no encontrada.', 'bg-red-600', statusElement);
                return;
            }

            const existingSong = allSongs.find(s => s.id === songToAddMetadata.id);

            const songRef = {
                songId: songToAddMetadata.id,
                songName: songToAddMetadata.name,
                url: existingSong?.url,
                order: folder.songReferences.length + 1,
            };
            
            const exists = folder.songReferences.some(ref => ref.songId === songRef.songId);
            if (exists) {
                displayStatus('La canción ya está en esta carpeta.', 'bg-yellow-600', statusElement);
                return;
            }

            try {
                const folderRef = doc(db, `artifacts/${appId}/public/data/${FOLDER_COLLECTION_NAME}`, folderId);
                
                const newSongReferences = [...folder.songReferences, songRef];
                
                await updateDoc(folderRef, {
                    songReferences: newSongReferences
                });
                
                displayStatus(`Canción añadida a "${folder.name}" con éxito!`, 'bg-green-600', statusElement);
                hideModal('addSongModal');
                songToAddMetadata = null;

            } catch (error) {
                console.error("Error adding song to folder:", error);
                displayStatus(`Error al añadir la canción: ${error.message}`, 'bg-red-600', statusElement);
            }
        });

        // --- LÓGICA DE CARPETAS ---

        // Listener para el botón de confirmación de creación de carpeta
        document.getElementById('create-folder-btn').addEventListener('click', createFolder);

        async function createFolder() {
            if (!db || !userId) return;

            const nameInput = document.getElementById('folder-name-input');
            const statusElement = document.getElementById('folder-creation-status');
            const folderName = nameInput.value.trim();

            if (!folderName) {
                displayStatus('El nombre de la carpeta no puede estar vacío.', 'bg-red-600', statusElement);
                return;
            }

            statusElement.classList.add('hidden');
            const createButton = document.getElementById('create-folder-btn');
            createButton.textContent = 'Creating...';
            createButton.disabled = true;

            try {
                const folderData = {
                    name: folderName,
                    ownerId: userId,
                    ownerNickname: userProfiles[userId] || `User-${userId.substring(0, 8)}...`,
                    songReferences: [], 
                    createdAt: new Date()
                };

                const collectionPath = `artifacts/${appId}/public/data/${FOLDER_COLLECTION_NAME}`;
                await addDoc(collection(db, collectionPath), folderData);

                displayStatus(`¡Carpeta "${folderName}" creada!`, 'bg-green-600', statusElement);
                nameInput.value = '';
                setTimeout(() => hideModal('createFolderModal'), 1000);

            } catch (error) {
                console.error("Error creando carpeta:", error);
                displayStatus(`Error creando carpeta: ${error.message}`, 'bg-red-600', statusElement);
            } finally {
                createButton.textContent = 'Create Folder';
                createButton.disabled = false;
            }
        }

        function setupFoldersListener() {
            if (!db || !userId) return;

            document.getElementById('folder-loading-spinner').classList.remove('hidden');
            foldersList.innerHTML = '';
            
            const collectionPath = `artifacts/${appId}/public/data/${FOLDER_COLLECTION_NAME}`;
            const q = query(collection(db, collectionPath));

            onSnapshot(q, (snapshot) => {
                document.getElementById('folder-loading-spinner').classList.add('hidden');
                allFolders = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    allFolders.push({ 
                        id: doc.id, 
                        ...data,
                        songReferences: data.songReferences || []
                    });
                });
                renderFoldersList(allFolders);

                if (currentFolderId) {
                    renderFolderDetail(currentFolderId);
                }
            }, (error) => {
                console.error("Error fetching folders (Permissions?):", error);
                document.getElementById('folder-loading-spinner').classList.add('hidden');
            });
        }

        function renderFoldersList(folders) {
            foldersList.innerHTML = '';
            
            if (folders.length === 0) {
                noFoldersMessage.classList.remove('hidden');
            } else {
                noFoldersMessage.classList.add('hidden');
                folders.forEach(folder => {
                    const folderElement = createFolderElement(folder);
                    foldersList.appendChild(folderElement);
                });
            }
        }

        function createFolderElement(folder) {
            const div = document.createElement('div');
            div.className = 'folder-item p-4 flex justify-between items-center cursor-pointer hover:bg-gray-600 transition';
            div.onclick = () => showView(`folderDetail-${folder.id}`); 
            
            const songCount = folder.songReferences ? folder.songReferences.length : 0;
            const owner = folder.ownerNickname || `User-${folder.ownerId.substring(0, 8)}...`;
            
            div.innerHTML = `
                <div class="flex items-center space-x-3">
                    <i data-lucide="folder" class="w-6 h-6 text-yellow-400"></i>
                    <div>
                        <p class="font-semibold text-lg text-gray-100">${folder.name}</p>
                        <p class="text-sm text-gray-400">${songCount} song${songCount === 1 ? '' : 's'} | Created by: ${owner}</p>
                    </div>
                </div>
                <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
            `;
            lucide.createIcons();
            return div;
        }

        function renderFolderDetail(folderId) {
            const folder = allFolders.find(f => f.id === folderId);
            const listElement = document.getElementById('folder-songs-list');
            
            if (!folder) {
                listElement.innerHTML = '<p class="text-red-400">Error: Carpeta no encontrada.</p>';
                return;
            }
            
            document.getElementById('folder-detail-name').textContent = folder.name;
            document.getElementById('folder-detail-owner').textContent = folder.ownerNickname;
            
            const songsInFolder = folder.songReferences.sort((a, b) => (a.order || 0) - (b.order || 0));
            listElement.innerHTML = '';

            if (songsInFolder.length === 0) {
                listElement.innerHTML = `<p class="text-center text-gray-500 mt-10">
                    Esta carpeta está vacía. Añade canciones desde la pestaña "Home & Upload".
                </p>`;
                saveOrderBtn.disabled = true;
                return;
            }
            
            songsInFolder.forEach((song, index) => {
                const songElement = createFolderSongElement(song, index + 1, folder.ownerId);
                listElement.appendChild(songElement);
            });
            
            setupDragAndDrop(listElement);
            saveOrderBtn.disabled = true;

            if (folder.ownerId !== userId) {
                 saveOrderBtn.disabled = true;
                 listElement.classList.add('pointer-events-none', 'opacity-75');
                 displayStatus('Solo el propietario puede ordenar esta carpeta.', 'bg-yellow-600', document.getElementById('folder-detail-view'));
            } else {
                 listElement.classList.remove('pointer-events-none', 'opacity-75');
            }
        }

        function createFolderSongElement(song, index, folderOwnerId) {
            const div = document.createElement('div');
            div.className = 'folder-song-item p-3 flex justify-between items-center bg-gray-600 border border-gray-500 cursor-move';
            div.setAttribute('draggable', folderOwnerId === userId); 
            div.setAttribute('data-song-id', song.songId);

            div.innerHTML = `
                <div class="flex items-center space-x-3 w-full">
                    <span class="text-xl font-bold text-gray-400 w-8 text-right">${index}.</span>
                    <div class="flex-grow">
                        <p class="font-medium text-lg">${song.songName}</p>
                        <audio controls class="mt-1 w-full" style="height: 35px;">
                            <source src="${song.url}" type="audio/mp3">
                        </audio>
                    </div>
                </div>
                ${folderOwnerId === userId ? `
                    <button class="remove-from-folder-btn p-2 rounded-full text-white bg-red-700 hover:bg-red-600 transition ml-3" data-song-id="${song.songId}">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                ` : ''}
            `;
            lucide.createIcons();
            
            const removeBtn = div.querySelector('.remove-from-folder-btn');
            if (removeBtn) {
                removeBtn.addEventListener('click', () => {
                    // Nota: Aquí se usa confirm() temporalmente
                    if (confirm("¿Estás seguro de que quieres quitar esta canción de la carpeta?")) {
                        removeSongFromFolder(currentFolderId, song.songId);
                    }
                });
            }

            return div;
        }

        let draggedItem = null;

        function setupDragAndDrop(container) {
            const items = container.querySelectorAll('.folder-song-item');

            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedItem = item;
                    setTimeout(() => item.classList.add('opacity-50'), 0);
                });

                item.addEventListener('dragend', () => {
                    draggedItem.classList.remove('opacity-50');
                    draggedItem = null;
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const boundingBox = item.getBoundingClientRect();
                    const offset = boundingBox.y + (boundingBox.height / 2);
                    
                    if (e.clientY < offset) {
                        if (item !== draggedItem) {
                            container.insertBefore(draggedItem, item);
                            saveOrderBtn.disabled = false;
                        }
                    } else {
                        if (item !== draggedItem) {
                            container.insertBefore(draggedItem, item.nextSibling);
                            saveOrderBtn.disabled = false;
                        }
                    }
                });
            });

            container.addEventListener('dragover', (e) => e.preventDefault());
        }

        saveOrderBtn.addEventListener('click', async () => {
            if (!currentFolderId || !db || !userId) return;

            const listItems = document.getElementById('folder-songs-list').querySelectorAll('.folder-song-item');
            
            const newSongReferences = Array.from(listItems).map((item, index) => {
                const songId = item.getAttribute('data-song-id');
                const existingRef = allFolders.find(f => f.id === currentFolderId)?.songReferences.find(s => s.songId === songId);
                
                return {
                    songId: existingRef.songId,
                    songName: existingRef.songName,
                    url: existingRef.url,
                    order: index + 1 
                };
            });

            const folderRef = doc(db, `artifacts/${appId}/public/data/${FOLDER_COLLECTION_NAME}`, currentFolderId);

            try {
                await updateDoc(folderRef, {
                    songReferences: newSongReferences
                });

                displayStatus('¡Orden de carpeta guardado con éxito!', 'bg-green-600', document.getElementById('folder-detail-view'));
                saveOrderBtn.disabled = true;

            } catch (error) {
                console.error("Error saving new folder order:", error);
                displayStatus(`Error al guardar el orden: ${error.message}`, 'bg-red-600', document.getElementById('folder-detail-view'));
            }
        });
        
        async function removeSongFromFolder(folderId, songId) {
            if (!folderId || !db || !userId) return;
            
            const folder = allFolders.find(f => f.id === folderId);
            if (!folder || folder.ownerId !== userId) return; 

            try {
                const newSongReferences = folder.songReferences
                    .filter(ref => ref.songId !== songId) 
                    .map((ref, index) => ({ ...ref, order: index + 1 })); 

                const folderRef = doc(db, `artifacts/${appId}/public/data/${FOLDER_COLLECTION_NAME}`, folderId);
                
                await updateDoc(folderRef, {
                    songReferences: newSongReferences
                });

                displayStatus('Canción eliminada de la carpeta.', 'bg-yellow-600', document.getElementById('folder-detail-view'));

            } catch (error) {
                console.error("Error removing song from folder:", error);
                displayStatus(`Error al eliminar la canción: ${error.message}`, 'bg-red-600', document.getElementById('folder-detail-view'));
            }
        }


        // --- INICIALIZACIÓN Y EVENTOS ---

        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                // Función de copia estándar para el navegador
                document.execCommand('copy'); 
                displayStatus('¡Enlace copiado al portapapeles!', 'bg-green-600');
            } catch (err) {
                console.error('Error al copiar el texto: ', err);
                displayStatus('Error al copiar el enlace.', 'bg-red-600');
            }
            document.body.removeChild(textarea);
        }

        uploadForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const mp3File = document.getElementById('mp3File').files[0];
            const customName = document.getElementById('customName').value.trim();

            if (!mp3File) {
                displayStatus("Por favor, selecciona un archivo MP3.", 'bg-red-600');
                return;
            }

            const MAX_FILE_SIZE = 40 * 1024 * 1024;
            if (mp3File.size > MAX_FILE_SIZE) {
                displayStatus("El archivo excede el límite de 40MB.", 'bg-red-600');
                return;
            }

            uploadFileAndSaveMetadata(mp3File, customName);
            uploadForm.reset(); 
        });

        searchInput.addEventListener('input', filterAndSortSongs);
        sortRadios.forEach(radio => radio.addEventListener('change', filterAndSortSongs));

        document.getElementById('nav-home').addEventListener('click', () => showView('home'));
        document.getElementById('nav-folders').addEventListener('click', () => showView('folders'));
        
        // Listener para el botón "Back to Folders"
        backToFoldersBtn.addEventListener('click', () => showView('folders'));

        document.getElementById('save-nickname-btn').addEventListener('click', () => {
            const nickname = document.getElementById('nickname-input').value;
            saveNickname(nickname);
        });

        // --- LÓGICA DE ACCESO CON CONTRASEÑA (NUEVO) ---
        
        function handlePasswordEntry() {
            const enteredPassword = passwordInput.value;
            if (enteredPassword === CORRECT_PASSWORD) {
                // Contraseña correcta
                const expiryTime = new Date().getTime() + THREE_DAYS_MS;
                localStorage.setItem(PASSWORD_STORAGE_KEY, expiryTime.toString());
                
                // Ocultar modal de contraseña y mostrar contenido principal
                passwordModal.classList.add('hidden');
                mainContentContainer.classList.remove('hidden');
                
                // Iniciar la aplicación
                initFirebase();

            } else {
                // Contraseña incorrecta
                displayPasswordStatus('Incorrect password. Access denied.', 'bg-red-600');
                passwordInput.value = ''; // Limpiar el campo
                passwordInput.focus();
            }
        }
        
        // Event Listeners para la modal de contraseña
        enterAccessBtn.addEventListener('click', handlePasswordEntry);
        passwordInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                handlePasswordEntry();
            }
        });

        // Función de chequeo de acceso inicial
        function checkPasswordAccess() {
            const storedExpiry = localStorage.getItem(PASSWORD_STORAGE_KEY);
            const currentTime = new Date().getTime();

            if (storedExpiry && parseInt(storedExpiry) > currentTime) {
                // Acceso válido (menos de 3 días)
                passwordModal.classList.add('hidden');
                mainContentContainer.classList.remove('hidden');
                initFirebase();
            } else {
                // Acceso expirado o nunca concedido
                passwordModal.classList.remove('hidden');
                mainContentContainer.classList.add('hidden');
                passwordInput.focus();
            }
        }

        window.onload = checkPasswordAccess;
        
        // --- FIN LÓGICA DE ACCESO CON CONTRASEÑA ---

        async function initFirebase() {
            const config = getFirebaseConfig();
            
            if (CLOUDINARY_CONFIG.cloudName === "YOUR_CLOUD_NAME" || CLOUDINARY_CONFIG.uploadPreset === "YOUR_UNSIGNED_UPLOAD_PRESET") {
                uploadButton.textContent = "CLOUDINARY CONFIG REQUIRED";
                uploadButton.classList.remove('btn-primary');
                uploadButton.classList.add('btn-danger');
                uploadButton.disabled = true;
                return;
            }

            try {
                uploadButton.textContent = "Connecting to DB...";
                uploadButton.disabled = true;

                app = initializeApp(config);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('error'); 

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        
                        const nicknameInput = document.getElementById('nickname-input');
                        const statusElement = document.getElementById('nickname-status');
                        
                        const profileRef = doc(db, `artifacts/${appId}/public/data/${PROFILE_COLLECTION_NAME}`, userId);
                        
                        // Obtener el nickname del perfil del usuario (ya configurado)
                        try {
                            const profileSnap = await getDoc(profileRef); 
                            if (profileSnap.exists()) {
                                nicknameInput.value = profileSnap.data().nickname;
                                userProfiles[userId] = profileSnap.data().nickname; // Aseguramos el caché inicial
                            } else {
                                nicknameInput.value = `User-${userId.substring(0, 5)}`;
                                displayStatus('Set your custom nickname!', 'bg-yellow-600', statusElement);
                            }
                        } catch (error) {
                             console.error("Error al obtener el perfil inicial (Permissions?):", error);
                             nicknameInput.value = `User-${userId.substring(0, 5)}`;
                             displayStatus('Error al cargar nickname de la DB. Revisa los permisos.', 'bg-red-600', statusElement);
                        }


                        uploadButton.textContent = "Upload";
                        uploadButton.classList.remove('btn-danger');
                        uploadButton.classList.add('btn-primary');
                        uploadButton.disabled = false;
                        
                        setupProfilesListener();
                        setupSongsListener();
                        setupFoldersListener(); 
                    } else {
                        isAuthReady = true;
                        userId = null;
                        uploadButton.textContent = "DB Configuration REQUIRED";
                        uploadButton.classList.add('btn-danger');
                        uploadButton.classList.remove('btn-primary');
                        uploadButton.disabled = true;
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization/Authentication Error:", error);
                uploadButton.textContent = "DB Failed. Check Console.";
                uploadButton.classList.remove('btn-primary');
                uploadButton.classList.add('btn-danger');
                uploadButton.disabled = true;
                loginStatusMessage.textContent = `FATAL: DB Error. ${error.code || error.message}`;
                loginStatusMessage.className = 'text-center text-sm text-red-400 py-2 rounded-md font-medium';
            }
        }
    </script>
</body>
</html>
