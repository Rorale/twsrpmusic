<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TWS Music Host Site - Upload & Share</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script> 
    <style>
        /* Paleta de colores Oscura */
        :root {
            --color-bg-light: #1f2937;
            --color-bg-card: #374151;
            --color-text: #f3f4f6;
            --color-input-bg: #4b5563;
            --color-primary: #3b82f6;
            --color-primary-hover: #2563eb;
            --color-secondary: #10b981;
            --color-danger: #ef4444;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--color-bg-light); 
            color: var(--color-text); 
        }
        .container { max-width: 90%; margin: 0 auto; padding: 20px; }
        .card { 
            background-color: var(--color-bg-card); 
            border: 1px solid #4b5563; 
            border-radius: 12px; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .input-style { 
            background-color: var(--color-input-bg); 
            border: 1px solid #6b7280; 
            color: var(--color-text);
            border-radius: 8px;
        }
        
        .btn-primary { background-color: var(--color-primary); color: white; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: var(--color-primary-hover); }
        .btn-secondary { background-color: #f59e0b; color: white; transition: background-color 0.2s; }
        .btn-secondary:hover { background-color: #d97706; }
        
        /* CAMBIO: Quitamos el cursor fijo de .btn-danger y lo manejamos con el atributo disabled */
        .btn-danger { background-color: var(--color-danger); color: white; transition: background-color 0.2s; }
        .btn-danger:hover { background-color: #dc2626; }
        
        button:disabled { cursor: not-allowed !important; opacity: 0.6; }
        button:enabled { cursor: pointer; }

        .nav-link { cursor: pointer; padding: 8px 12px; border-radius: 6px; }
        .nav-link.active { background-color: var(--color-primary); color: white; }

        audio::-webkit-media-controls-panel { background-color: #4b5563; border-radius: 8px; }
        audio { height: 40px; }

        .song-item, .folder-item, .folder-song-item {
            border: 1px solid #4b5563;
            border-radius: 8px;
            background-color: #4b5563;
            transition: box-shadow 0.2s;
        }
        .song-item:hover, .folder-item:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #login-status-message { display: none; }
    </style>
</head>
<body class="min-h-screen p-4">

    <header class="flex justify-between items-center py-4 border-b border-gray-600 mb-6">
        <h1 class="text-3xl font-extrabold text-gray-100">
            <span class="text-blue-500">T</span><span class="text-yellow-500">W</span><span class="text-red-500">S</span> Music Host Site
        </h1>
        <nav class="flex items-center space-x-2">
            <div class="flex space-x-2">
                <span id="nav-home" class="nav-link active font-medium" data-view="home">Home & Upload</span>
                <span id="nav-folders" class="nav-link font-medium" data-view="folders">Folders</span>
            </div>
            <button id="settings-btn" class="p-2 rounded-full hover:bg-gray-700 transition" onclick="showModal('settingsModal')">
                 <i data-lucide="settings" class="w-5 h-5 text-gray-400"></i>
            </button>
        </nav>
    </header>

    <div id="main-content-container">
        <div id="home-view" class="lg:flex lg:space-x-8">
            <div id="upload-card" class="w-full lg:w-1/2 p-6 card mb-8 lg:mb-0">
                <h2 class="text-2xl font-bold mb-6 text-center text-gray-100">Upload your MP3s here</h2>
                <div id="upload-status" class="hidden p-3 rounded-lg text-sm mb-4 font-semibold" role="alert"></div>

                <form id="uploadForm" class="space-y-6">
                    <p class="text-red-400 text-sm font-semibold">Note: Max size 40MB. For RP purposes only.</p>
                    <div>
                        <label for="mp3File" class="block text-sm font-medium mb-1 text-gray-300">Choose MP3 File</label>
                        <input type="file" id="mp3File" accept="audio/mp3" required class="input-style p-3 w-full rounded-lg cursor-pointer file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-800 file:text-blue-200 hover:file:bg-blue-700">
                    </div>
                    <div>
                        <label for="customName" class="block text-sm font-medium mb-1 text-gray-300">Custom Name (Used for URL)</label>
                        <input type="text" id="customName" placeholder="Ex: Airship" class="input-style p-3 w-full rounded-lg">
                    </div>
                    
                    <button type="submit" id="uploadButton" class="w-full py-3 rounded-lg font-bold text-lg btn-danger" disabled>
                        Connecting to Database...
                    </button>

                    <div id="login-status-message">Please log in to access the system.</div>
                </form>
            </div>

            <div id="links-card" class="w-full lg:w-1/2 p-6 card">
                <h2 class="text-2xl font-bold mb-6 text-center text-gray-100">Uploaded Music Links</h2>
                <div id="loading-spinner" class="hidden text-center py-10">
                    <div class="animate-spin inline-block w-8 h-8 border-4 border-t-4 border-blue-400 border-opacity-25 rounded-full"></div>
                    <p class="text-blue-400 mt-2">Loading songs...</p>
                </div>
                <p class="text-right text-gray-400 mb-4">Total: <span id="song-count" class="font-bold">0</span> songs</p>
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0 sm:space-x-4">
                    <input type="text" id="search-input" placeholder="Search song by name..." class="input-style p-3 rounded-lg w-full sm:w-2/3">
                    <div class="flex space-x-2 text-sm text-gray-300 font-medium">
                        <label><input type="radio" name="sort" value="alpha"> Alpha</label>
                        <label><input type="radio" name="sort" value="newest" checked> Newest</label>
                    </div>
                </div>
                <div id="music-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                    <div id="no-songs-message" class="text-center text-gray-500 mt-10 hidden">No songs found.</div>
                </div>
            </div>
        </div>

        <div id="folders-view" class="hidden p-6 card">
            <div id="folders-main-content">
                <div class="flex justify-between items-center mb-6 border-b border-gray-600 pb-4">
                    <h2 class="text-2xl font-bold text-gray-100">User Folders (Playlists)</h2>
                    <button class="py-2 px-4 rounded-lg text-white font-semibold bg-green-600 hover:bg-green-700 transition" onclick="showModal('createFolderModal')">
                        <i data-lucide="folder-plus" class="w-5 h-5 inline mr-1"></i> Create Folder
                    </button>
                </div>
                <div id="folder-loading-spinner" class="hidden text-center py-10">
                    <div class="animate-spin inline-block w-8 h-8 border-4 border-t-4 border-blue-400 border-opacity-25 rounded-full"></div>
                </div>
                <div id="folders-list" class="space-y-4 min-h-[400px]"></div>
            </div>

            <div id="folder-detail-view" class="hidden mt-8 p-6 card w-full">
                <button id="back-to-folders-btn" class="text-blue-400 hover:text-blue-300 mb-4 font-semibold">&larr; Back to Folders</button>
                <div class="flex justify-between items-center border-b border-gray-600 pb-3 mb-4">
                    <h3 id="folder-detail-name" class="text-3xl font-bold text-yellow-400"></h3>
                    <p class="text-sm text-gray-400">Owner: <span id="folder-detail-owner" class="font-medium"></span></p>
                </div>
                <p class="text-gray-400 mb-4">Drag and drop songs to reorder.</p>
                <div id="folder-songs-list" class="space-y-3"></div>
                <div class="mt-6 flex justify-end">
                    <button id="save-order-btn" class="py-2 px-4 rounded-lg text-white font-semibold bg-green-600 hover:bg-green-700 transition" disabled>Save Order</button>
                </div>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="bg-gray-700 p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">Settings</h3>
            <input type="text" id="nickname-input" class="input-style p-2 w-full mb-4" placeholder="Nickname">
            <div class="flex justify-end space-x-2">
                <button class="bg-red-600 p-2 rounded text-white" onclick="hideModal('settingsModal')">Close</button>
                <button id="save-nickname-btn" class="bg-blue-600 p-2 rounded text-white">Save</button>
            </div>
        </div>
    </div>

    <div id="createFolderModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="bg-gray-700 p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">Create Folder</h3>
            <input type="text" id="folder-name-input" class="input-style p-2 w-full mb-4" placeholder="Folder Name">
            <div class="flex justify-end space-x-2">
                <button class="bg-red-600 p-2 rounded text-white" onclick="hideModal('createFolderModal')">Cancel</button>
                <button id="create-folder-btn" class="bg-green-600 p-2 rounded text-white">Create</button>
            </div>
        </div>
    </div>

    <div id="addSongModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="bg-gray-700 p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">Add "<span id="song-to-add-name" class="text-yellow-400"></span>" to Folder</h3>
            <select id="folder-select" class="input-style p-2 w-full mb-4"></select>
            <div class="flex justify-end space-x-2">
                <button class="bg-red-600 p-2 rounded text-white" onclick="hideModal('addSongModal')">Cancel</button>
                <button id="confirm-add-song-btn" class="bg-blue-600 p-2 rounded text-white" disabled>Add Song</button>
            </div>
        </div>
    </div>

    <script>
        function showModal(id) { document.getElementById(id)?.classList.remove('hidden'); }
        function hideModal(id) { document.getElementById(id)?.classList.add('hidden'); }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, deleteDoc, doc, setDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        lucide.createIcons();

        // Configuración
        const appId = 'default-app-id';
        const CLOUDINARY_CONFIG = { cloudName: "daj3jaqd9", uploadPreset: "tws_music_uploads", folder: "music" };
        const SONG_COLLECTION_NAME = 'uploaded_songs_cloudinary';
        const PROFILE_COLLECTION_NAME = 'user_profiles';
        const FOLDER_COLLECTION_NAME = 'user_folders';

        let db, auth, userId = null;
        let allSongs = [], userProfiles = {}, allFolders = [];
        let currentFolderId = null, songToAddMetadata = null;

        const uploadButton = document.getElementById('uploadButton');
        const musicList = document.getElementById('music-list');
        const searchInput = document.getElementById('search-input');

        function createSafePublicId(text) {
            return text.trim().replace(/[\\/:*?"<>|&#]/g, '').replace(/[\s\-\.]+/g, '_');
        }

        // CAMBIO: Lógica de subida refinada para evitar duplicados y limpiar links
        async function uploadFileAndSaveMetadata(file, customName) {
            if (!db || !userId) return;
            const songName = customName || file.name.split('.').slice(0, -1).join('.');
            const safePublicId = createSafePublicId(songName); 

            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_CONFIG.uploadPreset);
            formData.append('folder', CLOUDINARY_CONFIG.folder);
            if (customName) formData.append('public_id', safePublicId);
            
            uploadButton.textContent = "Uploading..."; 
            uploadButton.disabled = true;

            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/upload`, { method: 'POST', body: formData });
                const data = await res.json();
                
                // MEJORA: Limpieza de URL para que sea link corto permanente
                const cleanUrl = data.secure_url.replace(/\/v[0-9]+\//, '/');

                // MEJORA: Usamos setDoc con ID fijo para SOBREESCRIBIR si el nombre es igual
                const docRef = doc(db, `artifacts/${appId}/public/data/${SONG_COLLECTION_NAME}`, safePublicId);
                await setDoc(docRef, {
                    name: songName,
                    fileName: file.name,
                    url: cleanUrl,
                    uploadedBy: userId,
                    timestamp: new Date(),
                    cloudinaryId: data.public_id
                }, { merge: true });

                alert("Success!");
            } catch (e) { alert("Error"); }
            finally { 
                uploadButton.textContent = "Upload"; 
                uploadButton.disabled = false; 
            }
        }

        // ... (Aquí sigue toda tu lógica de Drag & Drop y Renderizado de index-1.html) ...
        // Se mantiene exactamente igual para no perder funcionalidad
        
        function setupDragAndDrop(container) {
            let draggedItem = null;
            const items = container.querySelectorAll('.folder-song-item');
            items.forEach(item => {
                item.addEventListener('dragstart', () => { draggedItem = item; item.classList.add('opacity-50'); });
                item.addEventListener('dragend', () => { item.classList.remove('opacity-50'); draggedItem = null; });
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (!draggedItem || draggedItem === item) return;
                    const bounding = item.getBoundingClientRect();
                    const offset = bounding.y + (bounding.height / 2);
                    const target = e.clientY < offset ? item : item.nextSibling;
                    container.insertBefore(draggedItem, target);
                    document.getElementById('save-order-btn').disabled = false;
                });
            });
        }

        function renderMusicList(songs) {
            musicList.innerHTML = '';
            document.getElementById('song-count').textContent = songs.length;
            songs.forEach(song => {
                const div = document.createElement('div');
                div.className = 'song-item p-3 flex flex-col md:flex-row justify-between items-center';
                div.innerHTML = `
                    <div class="flex-grow w-full">
                        <p class="font-semibold text-lg">${song.name}</p>
                        <p class="text-xs text-gray-400">By: ${userProfiles[song.uploadedBy] || 'User'}</p>
                        <audio controls class="mt-2 w-full"><source src="${song.url}" type="audio/mp3"></audio>
                    </div>
                    <div class="flex space-x-2 mt-2">
                        <button class="bg-green-600 p-2 rounded text-white font-bold text-xs" onclick="navigator.clipboard.writeText('${song.url}'); alert('Copied!')">Copy Link</button>
                        ${song.uploadedBy === userId ? `<button class="bg-red-600 p-2 rounded text-white font-bold text-xs delete-song" data-id="${song.id}">Delete</button>` : ''}
                    </div>
                `;
                const delBtn = div.querySelector('.delete-song');
                if(delBtn) delBtn.onclick = () => deleteDoc(doc(db, `artifacts/${appId}/public/data/${SONG_COLLECTION_NAME}`, song.id));
                musicList.appendChild(div);
            });
        }

        async function init() {
            const config = {
                apiKey: "AIzaSyBipp_qEAamELRQJDGz7wWb6LUDyj7-cRQ",
                authDomain: "music-host-site.firebaseapp.com",
                projectId: "music-host-site",
                appId: "1:761480568190:web:0b9ff1adbe1843c86f672f"
            };
            const app = initializeApp(config);
            db = getFirestore(app);
            auth = getAuth(app);
            await signInAnonymously(auth);
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    
                    // CAMBIO: Al conectar, transformamos el botón de Error (Rojo) a Upload (Azul)
                    uploadButton.textContent = "Upload";
                    uploadButton.disabled = false;
                    uploadButton.classList.remove('btn-danger');
                    uploadButton.classList.add('btn-primary');

                    onSnapshot(collection(db, `artifacts/${appId}/public/data/${SONG_COLLECTION_NAME}`), snap => {
                        allSongs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        renderMusicList(allSongs);
                    });
                    
                    onSnapshot(collection(db, `artifacts/${appId}/public/data/${PROFILE_COLLECTION_NAME}`), snap => {
                        snap.forEach(d => userProfiles[d.id] = d.data().nickname);
                    });
                }
            });
        }
        
        document.getElementById('uploadForm').onsubmit = (e) => {
            e.preventDefault();
            uploadFileAndSaveMetadata(document.getElementById('mp3File').files[0], document.getElementById('customName').value);
        };
        init();
    </script>
</body>
</html>
