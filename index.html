<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TWS Music Host Site - Upload & Share</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script> 
    <style>
        :root {
            --color-bg-light: #1f2937; 
            --color-bg-card: #374151; 
            --color-text: #f3f4f6; 
            --color-input-bg: #4b5563; 
            --color-primary: #3b82f6; 
            --color-primary-hover: #2563eb;
            --color-secondary: #10b981; 
            --color-danger: #ef4444; 
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--color-bg-light); color: var(--color-text); }
        .container { max-width: 90%; margin: 0 auto; padding: 20px; }
        .card { background-color: var(--color-bg-card); border: 1px solid #4b5563; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2); }
        .input-style { background-color: var(--color-input-bg); border: 1px solid #6b7280; color: var(--color-text); border-radius: 8px; }
        .btn-primary { background-color: var(--color-primary); color: white; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: var(--color-primary-hover); }
        .btn-secondary { background-color: #f59e0b; color: white; transition: background-color 0.2s; }
        .btn-danger { background-color: var(--color-danger); color: white; transition: background-color 0.2s; }
        .nav-link { cursor: pointer; padding: 8px 12px; border-radius: 6px; }
        .nav-link.active { background-color: var(--color-primary); color: white; }
        audio::-webkit-media-controls-panel { background-color: #4b5563; border-radius: 8px; }
        .song-item, .folder-item, .folder-song-item { border: 1px solid #4b5563; border-radius: 8px; background-color: #4b5563; }
        #login-status-message { display: none; }
    </style>
</head>
<body class="min-h-screen p-4">

    <header class="flex justify-between items-center py-4 border-b border-gray-600 mb-6">
        <h1 class="text-3xl font-extrabold text-gray-100">
            <span class="text-blue-500">T</span><span class="text-yellow-500">W</span><span class="text-red-500">S</span> Music Host Site
        </h1>
        <nav class="flex items-center space-x-2">
            <div class="flex space-x-2">
                <span id="nav-home" class="nav-link active font-medium" onclick="showView('home')">Home & Upload</span>
                <span id="nav-folders" class="nav-link font-medium" onclick="showView('folders')">Folders</span>
            </div>
            <button class="p-2 rounded-full hover:bg-gray-700 transition" onclick="showModal('settingsModal')">
                 <i data-lucide="settings" class="w-5 h-5 text-gray-400"></i>
            </button>
        </nav>
    </header>

    <div id="main-content-container">
        <div id="home-view" class="lg:flex lg:space-x-8">
            <div id="upload-card" class="w-full lg:w-1/2 p-6 card mb-8 lg:mb-0">
                <h2 class="text-2xl font-bold mb-6 text-center text-gray-100">Upload your MP3s here</h2>
                <div id="upload-status" class="hidden p-3 rounded-lg text-sm mb-4 font-semibold"></div>
                <form id="uploadForm" class="space-y-6">
                    <p class="text-red-400 text-sm font-semibold">Note: Max. file size upload is 40MB.</p>
                    <div>
                        <label class="block text-sm font-medium mb-1 text-gray-300">Choose MP3 File</label>
                        <input type="file" id="mp3File" accept="audio/mp3" required class="input-style p-3 w-full file:bg-blue-800 file:text-white file:rounded-full">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1 text-gray-300">Custom Name</label>
                        <input type="text" id="customName" placeholder="Ex: Airship" class="input-style p-3 w-full">
                    </div>
                    <button type="submit" id="uploadButton" class="w-full py-3 rounded-lg font-bold text-lg btn-primary opacity-50 cursor-not-allowed" disabled>
                        Connecting to DB...
                    </button>
                </form>
            </div>

            <div id="links-card" class="w-full lg:w-1/2 p-6 card">
                <h2 class="text-2xl font-bold mb-6 text-center text-gray-100">Uploaded Music Links</h2>
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-x-4">
                    <input type="text" id="search-input" placeholder="Search..." class="input-style p-3 w-full">
                    <div class="flex space-x-2 text-sm">
                        <label><input type="radio" name="sort" value="newest" checked> Newest</label>
                        <label><input type="radio" name="sort" value="alpha"> Alpha</label>
                    </div>
                </div>
                <div id="music-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div>
            </div>
        </div>

        <div id="folders-view" class="hidden p-6 card">
            <div class="flex justify-between items-center mb-6 border-b border-gray-600 pb-4">
                <h2 class="text-2xl font-bold text-gray-100">User Folders</h2>
                <button class="py-2 px-4 rounded-lg bg-green-600 font-semibold" onclick="showModal('createFolderModal')">Create Folder</button>
            </div>
            <div id="folders-list" class="space-y-4"></div>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="bg-gray-700 p-6 rounded-lg w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">Settings</h3>
            <input type="text" id="nickname-input" class="input-style p-2 w-full mb-4" placeholder="Nickname">
            <button id="save-nickname-btn" class="w-full btn-primary p-2 rounded mb-2">Save</button>
            <button onclick="hideModal('settingsModal')" class="w-full btn-danger p-2 rounded" style="cursor:pointer">Close</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, updateDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        lucide.createIcons();

        function getCleanUrl(url) {
            return url.replace(/\/v\d+\//, '/');
        }

        const firebaseConfig = {
            apiKey: "AIzaSyBipp_qEAamELRQJDGz7wWb6LUDyj7-cRQ",
            authDomain: "music-host-site.firebaseapp.com",
            projectId: "music-host-site",
            storageBucket: "music-host-site.firebasestorage.app",
            messagingSenderId: "761480568190",
            appId: "1:761480568190:web:0b9ff1adbe1843c86f672f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userId = null;
        let allSongs = [];

        async function uploadFile(file, customName) {
            const btn = document.getElementById('uploadButton');
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', "tws_music_uploads");
            formData.append('folder', "music");
            if(customName) formData.append('public_id', customName.trim().replace(/\s+/g, '_'));

            btn.textContent = "Uploading..."; btn.disabled = true;
            try {
                const resp = await fetch(`https://api.cloudinary.com/v1_1/daj3jaqd9/upload`, { method: 'POST', body: formData });
                const data = await resp.json();
                const cleanUrl = getCleanUrl(data.secure_url);

                await addDoc(collection(db, "artifacts/default-app-id/public/data/uploaded_songs_cloudinary"), {
                    name: customName || file.name,
                    url: cleanUrl,
                    uploadedBy: userId,
                    timestamp: new Date()
                });
                alert("Upload Successful!");
            } catch (e) { alert("Error uploading"); }
            finally { btn.textContent = "Upload"; btn.disabled = false; }
        }

        // Lógica de Renderizado y Listeners
        function renderSongs(songs) {
            const list = document.getElementById('music-list');
            list.innerHTML = '';
            songs.forEach(song => {
                const div = document.createElement('div');
                div.className = 'song-item p-3 flex justify-between items-center';
                div.innerHTML = `
                    <div class="flex-grow"><p class="font-bold">${song.name}</p><audio controls class="w-full h-8 mt-1"><source src="${song.url}"></audio></div>
                    <button onclick="copyToClipboard('${song.url}')" class="ml-4 p-2 bg-green-600 rounded text-xs font-bold">Copy Link</button>
                `;
                list.appendChild(div);
            });
        }

        window.copyToClipboard = (url) => {
            navigator.clipboard.writeText(url).then(() => alert("Copiado: " + url));
        };

        window.showView = (view) => {
            document.getElementById('home-view').classList.toggle('hidden', view !== 'home');
            document.getElementById('folders-view').classList.toggle('hidden', view !== 'folders');
        };

        window.showModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.hideModal = (id) => document.getElementById(id).classList.add('hidden');

        // ACTIVACIÓN DEL BOTÓN AL CARGAR USUARIO
        onAuthStateChanged(auth, (user) => {
            const btn = document.getElementById('uploadButton');
            if (user) {
                userId = user.uid;
                btn.disabled = false;
                btn.textContent = "Upload";
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                
                onSnapshot(query(collection(db, "artifacts/default-app-id/public/data/uploaded_songs_cloudinary")), (snap) => {
                    allSongs = snap.docs.map(doc => doc.data()).sort((a,b) => b.timestamp - a.timestamp);
                    renderSongs(allSongs);
                });
            } else {
                btn.textContent = "Auth Error";
                btn.classList.add('btn-danger');
            }
        });

        document.getElementById('uploadForm').onsubmit = (e) => {
            e.preventDefault();
            uploadFile(document.getElementById('mp3File').files[0], document.getElementById('customName').value);
        };
    </script>
</body>
</html>
